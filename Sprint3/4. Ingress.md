# Ingress

### 커뮤니티용 (kubernetes/ingress-nginx)

- [Nginx User Guide](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/)
- [Github](https://github.com/kubernetes/ingress-nginx)
- [Supported Version](https://github.com/kubernetes/ingress-nginx#supported-versions-table)
- [Artifact Hub](https://artifacthub.io/packages/helm/ingress-nginx/ingress-nginx)

### Nginx Inc에서 제공(상용) (nginxinc/kubernetes-ingress)

- [Nginx User Guide](https://docs.nginx.com/nginx-ingress-controller)
- [Github](https://github.com/nginxinc/kubernetes-ingress)
- [Supported Version](https://docs.nginx.com/nginx-ingress-controller/technical-specifications/#supported-kubernetes-versions)
- [Artifact Hub](https://artifacthub.io/packages/helm/nginx/nginx-ingress)

<hr style="height:4px; border:none; color:#333; background-color:#333;" />

## 1. Nginx 설치

### 1-1. Master Server에서 helm 설치

```
[root@k8s-master ~]# curl -O https://get.helm.sh/helm-v3.13.2-linux-amd64.tar.gz
[root@k8s-master ~]# tar -zxvf helm-v3.13.2-linux-amd64.tar.gz
[root@k8s-master ~]# mv linux-amd64/helm /usr/bin/helm
```

### 1-2. Nginx 다운로드 및 배포

```
[root@k8s-master ~]# helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
[root@k8s-master ~]# helm pull ingress-nginx/ingress-nginx --version 4.10.0

//압축 해제
[root@k8s-master ~]# tar -xf ingress-nginx-4.10.0.tgz

//배포
[root@k8s-master ~]# cd ingress-nginx
[root@k8s-master ingress-nginx]# curl -O https://raw.githubusercontent.com/hyungeunShin/Kubernetes-Install/main/base/cicd-server/nginx/helm/ingress-nginx/values-dev.yaml
[root@k8s-master ingress-nginx]# helm upgrade ingress-nginx . -f ./values-dev.yaml -n ingress-nginx --install --create-namespace
```

---

## 2. Nginx 구성 확인

### 2-1. 설치 후 Nginx 구성 확인

```
[root@k8s-master ~]# kubectl get ns ingress-nginx
[root@k8s-master ~]# kubectl get svc -n ingress-nginx
[root@k8s-master ~]# kubectl get deploy -n ingress-nginx
[root@k8s-master ~]# kubectl get pod -n ingress-nginx
```

### 2-2. 설치 시 생성된 IngressClass 확인

```
[root@k8s-master ~]# kubectl get ingressclasses.networking.k8s.io nginx -o yaml
```

```yaml
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: nginx
  annotations:
    ingressclass.kubernetes.io/is-default-class: "true"
spec:
  controller: k8s.io/ingress-nginx
```

### 2-3. Nginx에 주입 된 IngressClass 확인

```
[root@k8s-master ~]# kubectl get pod -n ingress-nginx -o yaml
```

```yaml
apiVersion: v1
items:
- apiVersion: v1
  spec:
    containers:
    - args:
      - --controller-class=k8s.io/ingress-nginx
      - --ingress-class=nginx
```

### 2-4. ClusterRole로 부여된 권한 확인

```
[root@k8s-master ~]# kubectl get clusterrole ingress-nginx -o yaml
```

```yaml
- apiGroups:
  - discovery.k8s.io
  resources:
  - endpointslices
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
```

### 2-5. ClusterRoleBinding으로 Role/Nginx SA 연결 확인

```
[root@k8s-master ~]# kubectl get clusterrolebindings ingress-nginx -o yaml
```

```yaml
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ingress-nginx
subjects:
- kind: ServiceAccount
  name: ingress-nginx
  namespace: ingress-nginx
```

---

## 3. 도메인 분리

### 3-1. Master Server에서 Yaml 파일 배포

```
[root@k8s-master ~]#
kubectl apply -f https://raw.githubusercontent.com/hyungeunShin/Kubernetes-Sprint3-Config/main/3222/deploy/k8s/namespace.yaml
kubectl apply -f https://raw.githubusercontent.com/hyungeunShin/Kubernetes-Sprint3-Config/main/3222/deploy/k8s/secret.yaml
kubectl apply -f https://raw.githubusercontent.com/hyungeunShin/Kubernetes-Sprint3-Config/main/3222/deploy/k8s/configmap.yaml
kubectl apply -f https://raw.githubusercontent.com/hyungeunShin/Kubernetes-Sprint3-Config/main/3222/deploy/k8s/core/ingress.yaml
kubectl apply -f https://raw.githubusercontent.com/hyungeunShin/Kubernetes-Sprint3-Config/main/3222/deploy/k8s/core/service.yaml
kubectl apply -f https://raw.githubusercontent.com/hyungeunShin/Kubernetes-Sprint3-Config/main/3222/deploy/k8s/core/deployment.yaml
kubectl apply -f https://raw.githubusercontent.com/hyungeunShin/Kubernetes-Sprint3-Config/main/3222/deploy/k8s/portal/ingress.yaml
kubectl apply -f https://raw.githubusercontent.com/hyungeunShin/Kubernetes-Sprint3-Config/main/3222/deploy/k8s/portal/service.yaml
kubectl apply -f https://raw.githubusercontent.com/hyungeunShin/Kubernetes-Sprint3-Config/main/3222/deploy/k8s/portal/deployment.yaml
```

### 3-2. Ingress 관련 구성 확인

- https://kubernetes.io/ko/docs/concepts/services-networking/ingress/
- https://kubernetes.io/ko/docs/concepts/services-networking/endpoint-slices/

```
[root@k8s-master ~]# kubectl get svc -n anotherclass-322 portal-3222
[root@k8s-master ~]# kubectl get ingress -n anotherclass-322 portal-3222 -o yaml
[root@k8s-master ~]# kubectl get endpoints -n anotherclass-322 portal-3222 -o yaml
[root@k8s-master ~]# kubectl get endpointslices -n anotherclass-322 portal-3222-<Press Tab> -o yaml
```

```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
spec:
  ingressClassName: nginx
  rules:
  - host: portal.com
    http:
      paths:
      - backend:
          service:
            name: portal-3222
            port:
              number: 80
        path: /
        pathType: Prefix
status:
  loadBalancer: {}
```

```
apiVersion: v1
kind: Endpoints
metadata:
  name: portal-3222
subsets:
- addresses:
  - ip: 20.108.82.232
    nodeName: k8s-master
    targetRef:
      kind: Pod
      name: portal-3222-dfd55498d-9l8jt
      namespace: anotherclass-322
      uid: f216c6f2-fcdc-47dc-8c81-5f1190e5788b
  - ip: 20.108.82.234
    nodeName: k8s-master
    targetRef:
      kind: Pod
      name: portal-3222-dfd55498d-rcn6k
      namespace: anotherclass-322
      uid: 08a8254e-effb-489f-a9a3-bbca7d5a69b4
```

```
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  name: portal-3222-t86qb
  namespace: anotherclass-322
addressType: IPv4
endpoints:
- addresses:
  - 20.108.82.234
  conditions:
    ready: true
    serving: true
    terminating: false
  nodeName: k8s-master
  targetRef:
    kind: Pod
    name: portal-3222-dfd55498d-rcn6k
    namespace: anotherclass-322
    uid: 08a8254e-effb-489f-a9a3-bbca7d5a69b4
- addresses:
  - 20.108.82.232
  conditions:
    ready: true
    serving: true
    terminating: false
  nodeName: k8s-master
  targetRef:
    kind: Pod
    name: portal-3222-dfd55498d-9l8jt
    namespace: anotherclass-322
    uid: f216c6f2-fcdc-47dc-8c81-5f1190e5788b
```

### 3-3. API 호출

▶ Master Server의 hosts 파일 수정

```
[root@k8s-master ~]# vi /etc/hosts
```

```
//추가
192.168.56.30 k8s.core
```

▶ 호스트 PC의 hosts 파일 수정

```
C:\Windows\System32\drivers\etc
```

```
//추가
192.168.56.30 portal.com k8s.core
```

▶ API 호출

```
[root@k8s-master ~]# curl k8s.core:31080/hostname

Chrome: http://portal.com:31080/hostname
```

▶ Nginx 로그 확인

```
[root@k8s-master ~]# kubectl logs -n ingress-nginx ingress-nginx-controller-<Press Tab> --tail 10
[root@k8s-master ~]# kubectl logs -n ingress-nginx ingress-nginx-controller-<Press Tab> --follow
```