# 빌드/배포 파이프라인을 위한 스크립트 작성 및 실행

## 1. 소스 빌드 하기

<img src="images/2/1.png" alt="">

### 1-1. 프로젝트 생성

```
2121-source-build
```

<img src="images/2/2.png" alt="">

### 1-2. Dashboard > 2121-source-build > Configure > General > GitHub project 선택

```
https://github.com/hyungeunShin/Kubernetes-App/
```

<img src="images/2/3.png" alt="">

### 1-3 소스 코드 관리

```
https://github.com/hyungeunShin/Kubernetes-App.git
```

<img src="images/2/4.png" alt="">

### 1-4. Build Steps > Invoke Gradle script

```
Gradle Version: gradle-7.6.1
Tasks: clean build
```

<img src="images/2/5.png" alt="">
<img src="images/2/6.png" alt="">

### 1-5. Dashboard > 2121-source-build > 지금 빌드 및 Console 확인

<img src="images/2/7.png" alt="">

### 1-6. 생성된 Jar 파일 확인

```
[jenkins@cicd-server ~]$ ll /var/lib/jenkins/workspace/2121-source-build/build/libs
```

---

## 2. 컨테이너 빌드 하기

<img src="images/2/1.png" alt="">

### 2-1. 프로젝트 생성

```
2121-container-build
```

<img src="images/2/8.png" alt="">

### 2-2. Dashboard > 2121-container-build > Configure > General > GitHub project 선택

```
https://github.com/hyungeunShin/Kubernetes-Sprint2-Config/
```

<img src="images/2/9.png" alt="">

### 2-3. 소스 코드 관리

```
https://github.com/hyungeunShin/Kubernetes-Sprint2-Config.git
```

<img src="images/2/10.png" alt="">

### 2-4. 소스 코드 관리 > Additional Behaviours > Sparse Checkout paths

```
2121/build/docker
```

<img src="images/2/11.png" alt="">

### 2-5. Build Steps > Execute shell

```
# jar 파일 복사
cp /var/lib/jenkins/workspace/2121-source-build/build/libs/app-0.0.1-SNAPSHOT.jar ./2121/build/docker/app-0.0.1-SNAPSHOT.jar

# 도커 빌드
docker build -t <DockerHub_Username>/api-tester:v1.0.0 ./2121/build/docker
docker push <DockerHub_Username>/api-tester:v1.0.0
```

<img src="images/2/12.png" alt="">

### 2-6. Dashboard > 2121-container-build > 지금 빌드 및 Console 확인

<img src="images/2/13.png" alt="">

### 2-7. Dockerfile 내용 확인

```
[jenkins@cicd-server ~]$ cat /var/lib/jenkins/workspace/2121-container-build/2121/build/docker/Dockerfile
```

---

## 3. 배포 하기

<img src="images/2/1.png" alt="">

### 3-1. 프로젝트 생성

```
item name: 2121-deploy
Copy from: 2121-container-build
```

<img src="images/2/14.png" alt="">

### 3-2. 소스 코드 관리 > Additional Behaviours > Sparse Checkout paths

```
2121/deploy/k8s
```

<img src="images/2/15.png" alt="">

### 3-3. Build Steps > Execute shell

```
kubectl apply -f ./2121/deploy/k8s/namespace.yaml
kubectl apply -f ./2121/deploy/k8s/pv.yaml
kubectl apply -f ./2121/deploy/k8s/pvc.yaml
kubectl apply -f ./2121/deploy/k8s/configmap.yaml
kubectl apply -f ./2121/deploy/k8s/secret.yaml
kubectl apply -f ./2121/deploy/k8s/service.yaml
kubectl apply -f ./2121/deploy/k8s/hpa.yaml
kubectl apply -f ./2121/deploy/k8s/deployment.yaml
```

<img src="images/2/16.png" alt="">


### 3-4. Dashboard > 2121-deploy > 지금 빌드 및 Console 확인

<img src="images/2/17.png" alt="">

### 3-5. Dashboard 확인

<img src="images/2/18.png" alt="">

---

## 4. 정리

```
[jenkins@cicd-server ~]$ kubectl delete ns anotherclass-212
```

---

## 5. View

<img src="images/2/19.png" alt="">
<img src="images/2/20.png" alt="">
<img src="images/2/21.png" alt="">
<img src="images/2/22.png" alt="">